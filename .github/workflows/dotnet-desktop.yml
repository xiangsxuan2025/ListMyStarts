name: C# Star List Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'  # 每天12点运行
  push:
    branches:
      - main

jobs:
  generate-star-list:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore ListMyStarts/ListMyStarts.csproj

    - name: Build project
      run: dotnet build ListMyStarts/ListMyStarts.csproj --configuration Release --no-restore

    - name: Run application
      run: |
        cd ListMyStarts
        dotnet run --configuration Release --no-build
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Debug - Check generated file
      shell: bash
      run: |
        echo "Checking generated file..."
        if [ -f "My Starts.md" ]; then
          echo "✅ File exists"
          echo "First 5 lines:"
          head -5 "My Starts.md"
        else
          echo "❌ File not found"
          ls -la
          exit 1
        fi

    - name: Commit and push changes
      shell: bash  # 使用 bash shell
      run: |
        git config --local user.email "xiangshouxuan@foxmail.com"
        git config --local user.name "xiangsxuan"
        git pull origin main
        
        # 检查是否有更改
        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          git commit -m ":sparkles: Update star list - $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "✅ Changes pushed successfully"
        fi