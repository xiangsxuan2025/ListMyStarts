name: C# Star List Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'  # 每天12点运行
  push:
    branches:
      - main

jobs:
  generate-star-list:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore ListMyStarts/ListMyStarts.csproj

    - name: Build project
      run: dotnet build ListMyStarts/ListMyStarts.csproj --configuration Release --no-restore

    - name: Run application
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Running the application..."
        cd ListMyStarts
        dotnet run --configuration Release --no-build
        
        # 检查生成的文件
        echo "Checking generated file..."
        if (Test-Path "..\My Starts.md") {
          echo "✅ File generated successfully"
          type "..\My Starts.md" | head -5
        } else {
          echo "❌ File not found"
          dir ..
          exit 1
        }

    - name: Commit and push changes
      run: |
        echo "Setting up git..."
        git config --global user.email "xiangshouxuan@foxmail.com"
        git config --global user.name "xiangsxuan"
        
        echo "Checking for changes..."
        git add .
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
        else
          echo "Committing changes..."
          git commit -m ":sparkles: Update star list - $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "Pushing to main..."
          git push origin main
          echo "✅ Changes pushed successfully"
        fi
