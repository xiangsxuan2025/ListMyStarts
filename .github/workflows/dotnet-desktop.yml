name: ListMyStarts Generator

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 12 * * *'  # 每天中午12点运行（UTC时间）

jobs:
  build:
    runs-on: ubuntu-latest  # 改为 Ubuntu Linux 环境

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Run application
      run: |
        cd ListMyStarts
        dotnet run --configuration Release --no-build
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Debug - Check generated file
      run: |
        echo "Checking generated file..."
        if [ -f "My Starts.md" ]; then
          echo "✅ File exists"
          echo "First 5 lines:"
          head -5 "My Starts.md"
        else
          echo "❌ File not found"
          ls -la
          exit 1
        fi

    - name: Commit and push changes
      run: |
        git config --global user.email "xiangshouxuan@foxmail.com"
        git config --global user.name "xiangsxuan"
        
        # 拉取最新代码避免冲突
        git pull origin main --rebase
        
        # 添加所有更改
        git add .
        
        # 检查是否有更改需要提交（这里使用 Bash 语法，Linux 环境支持）
        if git diff --cached --quiet; then
          echo "✅ No changes to commit"
        else
          git commit -m ":sparkles: Update star list $(date '+%Y-%m-%d %H:%M')"
          echo "✅ Changes committed"
          git push origin main
        fi